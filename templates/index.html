<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Buddy - Data Enrichment Made Easy</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        .workflow-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .section-title {
            color: #0d6efd;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .checkbox-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: white;
        }

        .instructions-section, .output-section, .api-config-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .dropdown-container {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .column-select {
            padding: 5px 10px;
            border-radius: 4px;
        }

        .column-select:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Data Buddy</h1>
        <p class="text-center">Clean, enrich, and enhance your data with just a few clicks.</p>

        <!-- API Key and GPT Model Section -->
        <div class="workflow-section">
            <h5 class="section-title">API Configuration</h5>
            <div class="api-config-section">
                <label for="api-key" class="form-label">OpenAI API Key:</label>
                <input type="text" id="api-key" class="form-control mb-3" placeholder="Enter your OpenAI API key" required>
                
                <label for="gpt-model" class="form-label">Select GPT Model:</label>
                <select id="gpt-model" class="form-select">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                </select>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title text-center">Step 1: Upload Your File</h4>
                        <p class="text-center">Upload a CSV file to start analyzing and improving your data.</p>
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" name="file" class="form-control" accept=".csv" required>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-success">Upload & Preview</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Preview Section -->
        <div id="file-preview" style="display: none;" class="mt-4">
            <h4 class="mb-4">Processing: <span id="file-name"></span></h4>
            <!-- Column Selection Section -->
            <div class="workflow-section">
                <h5 class="section-title">Step 2: Select Columns to Analyze</h5>
                <div>
                    <input type="checkbox" id="select-all" class="form-check-input">
                    <label for="select-all" class="form-check-label">Select/Unselect All</label>
                </div>
                <div class="checkbox-container" id="column-checkboxes"></div>
            </div>

            <!-- Instructions Section -->
            <div class="workflow-section">
                <h5 class="section-title">Step 3: Configure Analysis</h5>
                <div class="instructions-section">
                    <h6>Reading Instructions:</h6>
                    <textarea id="read-instructions" class="form-control" rows="3" 
                        placeholder="Example: 'Analyze these columns to determine if this company would be a good Amazon client.'"></textarea>
                </div>
                <div class="output-section">
                    <h6>Output Format:</h6>
                    <textarea id="output-instructions" class="form-control" rows="3" 
                        placeholder="Example: 'In three words or less, categorize this company's potential as an Amazon client.'"></textarea>
                </div>
                <div class="dropdown-container">
                    <label for="num-columns" class="form-label">Number of Output Columns:</label>
                    <select id="num-columns" class="form-select">
                        <option value="1">1 Column</option>
                        <option value="2">2 Columns</option>
                        <option value="3">3 Columns</option>
                        <option value="4">4 Columns</option>
                        <option value="5">5 Columns</option>
                    </select>
                </div>
            </div>

            <div class="text-center mt-4">
                <button id="start-process" class="btn btn-primary btn-lg">Start Processing</button>
            </div>
        </div>

        <!-- Progress Bar Section -->
        <div class="progress mt-4" id="progress-bar" style="display: none;">
            <div class="progress-bar" role="progressbar" style="width: 0%;" id="progress">0%</div>
        </div>

        <!-- Download Section -->
        <div id="download-section" class="text-center mt-4" style="display: none;">
            <h4>Processing Complete!</h4>
            <a id="download-link" class="btn btn-success" href="#" download>Download Processed File</a>
        </div>

        <footer class="text-center mt-5">
            <p>&copy; 2024 Data Buddy. All Rights Reserved.</p>
        </footer>
    </div>
    <script>
        // File upload handling
        document.querySelector('#upload-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            console.log('Form submitted');
        
            const formData = new FormData(this);
            
            try {
                console.log('Sending request to /upload...');
                const response = await axios.post('/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                console.log('Server response:', response.data);
        
                // Show the columns as checkboxes
                const checkboxesContainer = document.querySelector('#column-checkboxes');
                checkboxesContainer.innerHTML = '';
                
                if (response.data && response.data.columns) {
                    response.data.columns.forEach(col => {
                        checkboxesContainer.innerHTML += `
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="${col}" value="${col}" checked>
                                <label class="form-check-label" for="${col}">${col}</label>
                            </div>
                        `;
                    });
        
                    // Show the file preview section
                    document.querySelector('#file-preview').style.display = 'block';
                    document.querySelector('#file-name').textContent = response.data.filename;
                    
                    // Store file path for later use
                    document.querySelector('#file-preview').dataset.filePath = response.data.file_path;
                } else {
                    console.error('No columns in response:', response.data);
                    alert('No columns found in file');
                }
        
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading file: ' + (error.response?.data?.error || error.message));
            }
        });
        
        // Select all checkbox functionality
        document.querySelector('#select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // Process button handling
        document.querySelector('#start-process').addEventListener('click', async function() {
            try {
                // Show progress bar
                const progressBar = document.querySelector('#progress-bar');
                const progressElement = document.querySelector('#progress');
                progressBar.style.display = 'block';
                progressElement.style.width = '0%';
                progressElement.textContent = '0%';
                
                // Get selected columns
                const selectedColumns = Array.from(document.querySelectorAll('#column-checkboxes input:checked'))
                    .map(checkbox => checkbox.value);
        
                if (selectedColumns.length === 0) {
                    alert('Please select at least one column to analyze');
                    return;
                }
        
                // Get other inputs
                const apiKey = document.querySelector('#api-key').value;
                if (!apiKey) {
                    alert('Please enter your OpenAI API key');
                    return;
                }
        
                const gptModel = document.querySelector('#gpt-model').value;
                const readInstructions = document.querySelector('#read-instructions').value;
                const outputInstructions = document.querySelector('#output-instructions').value;
                const numColumns = document.querySelector('#num-columns').value;
                const filePath = document.querySelector('#file-preview').dataset.filePath;
        
                if (!readInstructions || !outputInstructions) {
                    alert('Please provide both reading and output instructions');
                    return;
                }
        
                // Send processing request
                console.log('Sending processing request...');
                const response = await axios.post('/process', {
                    selected_columns: selectedColumns,
                    api_key: apiKey,
                    gpt_model: gptModel,
                    read_instructions: readInstructions,
                    output_instructions: outputInstructions,
                    num_output_columns: numColumns,  // Changed from num_columns to num_output_columns
                    file_path: filePath
                });
        
                console.log('Processing response:', response.data);
        
                // Hide progress bar
                progressBar.style.display = 'none';
        
                // Show download link
                const downloadSection = document.querySelector('#download-section');
                const downloadLink = document.querySelector('#download-link');
                downloadSection.style.display = 'block';
                downloadLink.href = `/download/${response.data.download_path}`;
                downloadLink.textContent = 'Download Processed File';
        
                alert('Processing complete! You can now download the processed file.');
        
            } catch (error) {
                console.error('Processing error:', error);
                alert('Error processing file: ' + (error.response?.data?.error || error.message));
            }
        });
        </script>
        
     
</body>
</html>
